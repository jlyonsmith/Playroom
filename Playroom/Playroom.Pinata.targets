<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- 
    Instructions for use:
    
    - Include this file after the Microsoft.CSharp.targets file 
    - Add a <Pinata Include="MyPinataFile.pinata" /> for each .pinata file
  -->
  <PropertyGroup>
    <CoreCompileDependsOn>$(CoreCompileDependsOn);GeneratePinataOutput</CoreCompileDependsOn>
    <CoreCleanDependsOn>$(CoreCleanDependsOn);CleanPinataOutput</CoreCleanDependsOn>
    <PlayroomAssemblyFile Condition="'$(PlayroomAssemblyFile)' == ''">&quot;$(MSBuildExtensionsPath)\Playroom\Playroom.dll&quot;</PlayroomAssemblyFile>
  </PropertyGroup>

  <UsingTask AssemblyFile="$(PlayroomAssemblyFile)" TaskName="Pinata" />
  
  <Target
    Name="CleanPinataOutput"
    Condition="'@(Pinata)' != ''" 
    DependsOnTargets = "PreparePinataOutputNames">
    <Delete
      Files="@(Pinata->'%(OutputName)')"
      TreatErrorsAsWarnings="true"/>
  </Target>

  <Target
    Name="PreparePinataOutputNames"
    Condition="'@(Pinata)' != ''">
    <ItemGroup>
      <!-- Add metadata to the pinata file item list for the output file names -->
      <Pinata>
        <OutputName Condition="'%(Pinata.OutputName)' == ''">$(IntermediateOutputPath)Rectangles.cs</OutputName>
      </Pinata>
      <!-- Add generated file to list of sources to be compiled-->
      <Compile Include="%(Pinata.OutputName)" />
    </ItemGroup>
    <Message Text="@(Pinata)" Importance="normal"/>
    <Message Text="@(Pinata->'%(OutputName)')" Importance="normal"/>
  </Target>

  <Target
    Name="GeneratePinataOutput"
    Condition="'@(Pinata)' != ''"
    DependsOnTargets = "PreparePinataOutputNames">

    <!-- Generate the wrapper class -->
    <Pinata InputFile="%(Pinata.Identity)" OutputFile="%(Pinata.OutputName)" />
  </Target>
</Project>

