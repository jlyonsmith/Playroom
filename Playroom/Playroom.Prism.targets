<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- 
    Instructions for use:
    
    - Include this file after the Microsoft.CSharp.targets file 
    - Add a <PrismFile Include="MyPrismFile.prism" /> for each .prism file
  -->
  <PropertyGroup>
    <CoreCompileDependsOn>$(CoreCompileDependsOn);GeneratePrismOutput</CoreCompileDependsOn>
    <CoreCleanDependsOn>$(CoreCleanDependsOn);CleanPrismOutput</CoreCleanDependsOn>
    <PrismExe Condition="'$(PrismExe)' == ''">&quot;$(MSBuildExtensionsPath)\Playroom\Prism.exe&quot;</PrismExe>
  </PropertyGroup>

  <Target
    Name="CleanPrismOutput"
    Condition="'@(PrismFile)' != ''"
    DependsOnTargets = "PreparePrismOutputNames">
    <Delete
      Files="@(PrismFile->'%(OutputName)')"
      TreatErrorsAsWarnings="true"/>
  </Target>

  <Target
    Name="PreparePrismOutputNames"
    Condition="'@(PrismFile)' != ''">
    <ItemGroup>
      <!-- Add metadata to the pinata file item list for the output file names -->
      <PrismFile>
        <OutputName Condition="'%(PrismFile.OutputName)' == ''">$(BaseIntermediateOutputPath)%(PrismFile.FileName).cs</OutputName>
      </PrismFile>
      <!-- Add generated file to list of sources to be compiled-->
      <Compile Include="%(PrismFile.OutputName)" />
    </ItemGroup>
  </Target>

  <Target
    Name="GeneratePrismOutput"
    Inputs="@(PrismFile);"
    Outputs="@(PrismFile->'%(OutputName)')"
    Condition="'@(PrismFile)' != ''"
    DependsOnTargets = "PreparePrismOutputNames">

    <!-- Generate the wrapper class -->
    <Exec Command="$(PrismExe) %(PrismFile.Identity) /o:%(PrismFile.OutputName)" />
  </Target>
</Project>

