<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- 
    Instructions for use:
    
    - Include this file after the Microsoft.CSharp.targets file 
    - Add a <CrayonFile Include="MyCrayonFile.crayon" /> for each .crayon file
  -->
  <PropertyGroup>
    <CoreCompileDependsOn>$(CoreCompileDependsOn);GenerateCrayonOutput</CoreCompileDependsOn>
    <CoreCleanDependsOn>$(CoreCleanDependsOn);CleanCrayonOutput</CoreCleanDependsOn>
    <CrayonExe Condition="'$(CrayonExe)' == ''">&quot;$(MSBuildExtensionsPath)\Playroom\Crayon.exe&quot;</CrayonExe>
  </PropertyGroup>

  <Target
    Name="CleanCrayonOutput"
    Condition="'@(CrayonFile)' != ''" 
    DependsOnTargets = "PrepareCrayonOutputNames">
    <Delete
      Files="@(CrayonFile->'%(OutputName)')"
      TreatErrorsAsWarnings="true"/>
  </Target>

  <Target
    Name="PrepareCrayonOutputNames"
    Condition="'@(CrayonFile)' != ''">
    <ItemGroup>
      <!-- Add metadata to the crayon file item list for the output file names -->
      <CrayonFile>
        <OutputName Condition="'%(CrayonFile.OutputName)' == ''">$(BaseIntermediateOutputPath)%(CrayonFile.FileName).cs</OutputName>
      </CrayonFile>
      <!-- Add generated file to list of sources to be compiled-->
      <Compile Include="%(CrayonFile.OutputName)" />
    </ItemGroup>
  </Target>

  <Target
    Name="GenerateCrayonOutput"
    Inputs="@(CrayonFile);"
    Outputs="@(CrayonFile->'%(OutputName)')"
    Condition="'@(CrayonFile)' != ''"
    DependsOnTargets = "PrepareCrayonOutputNames">

    <!-- Generate the wrapper class -->
    <Exec Command="$(CrayonExe) %(CrayonFile.Identity) /o:%(CrayonFile.OutputName)" />
  </Target>
</Project>

